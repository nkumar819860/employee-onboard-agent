<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" 
      xmlns:db="http://www.mulesoft.org/schema/mule/db" 
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
      xmlns:http="http://www.mulesoft.org/schema/mule/http" 
      xmlns:mcp="http://www.mulesoft.org/schema/mule/mcp" 
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd 
                          http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
                          http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
                          http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
                          http://www.mulesoft.org/schema/mule/mcp http://www.mulesoft.org/schema/mule/mcp/current/mule-mcp.xsd">

    <!-- Employee Onboarding MCP Server Flows -->
    
    <!-- Health Check Endpoint -->
    <flow name="health-check" doc:id="h1e2a3l4-t5h6-c7h8-e9c0-k1i2n3g4h5e6">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/health" doc:name="Health Check Listener" doc:id="h2e3a4l5-t6h7-c8h9-e0c1-k2i3n4g5h6e7"/>
        <ee:transform doc:name="Health Response" doc:id="h3e4a5l6-t7h8-c9h0-e1c2-k3i4n5g6h7e8">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: "healthy",
    service: "Employee Onboarding MCP Server",
    timestamp: now(),
    version: "1.0.0",
    endpoints: [
        "/health",
        "/createEmployee",
        "/getEmployee/{employeeId}",
        "/listEmployees",
        "/updateTask",
        "/processOnboardingRequest"
    ]
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>

    <!-- NLP-Powered Onboarding Request Processor -->
    <flow name="process-onboarding-request" doc:id="n1l2p3o4-n5b6-o7a8-r9d0-r1e2q3u4e5s6">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/processOnboardingRequest" doc:name="Process Onboarding Request Listener" doc:id="n2l3p4o5-n6b7-o8a9-r0d1-r2e3q4u5e6s7"/>
        <set-variable variableName="requestPayload" value="#[payload]" doc:name="Set Request Payload"/>
        <logger level="INFO" doc:name="Log NLP Request" message="Processing NLP request: #[vars.requestPayload]"/>
        
        <!-- Extract entities from NLP request -->
        <ee:transform doc:name="Extract Entities" doc:id="n3l4p5o6-n7b8-o9a0-r1d2-r3e4q5u6e7s8">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
import * from dw::core::Strings
var requestText = lower(vars.requestPayload.prompt default "")
var extractedData = {
    // Extract department
    department: if (requestText contains "hr" or requestText contains "human resources") "HR"
                else if (requestText contains "it" or requestText contains "technology" or requestText contains "software") "IT"
                else if (requestText contains "sales" or requestText contains "marketing") "Sales"
                else if (requestText contains "finance" or requestText contains "accounting") "Finance"
                else "General",
    
    // Extract job title patterns
    jobTitle: if (requestText contains "engineer" or requestText contains "developer") "Software Engineer"
              else if (requestText contains "manager") "Manager"
              else if (requestText contains "analyst") "Business Analyst"
              else if (requestText contains "coordinator") "Coordinator"
              else "Employee",
    
    // Extract equipment needs
    equipment: flatten([
        if (requestText contains "laptop" or requestText contains "computer") ["laptop"] else [],
        if (requestText contains "phone" or requestText contains "mobile") ["phone"] else [],
        if (requestText contains "badge" or requestText contains "access card") ["security_badge"] else []
    ]),
    
    // Extract urgency
    priority: if (requestText contains "urgent" or requestText contains "asap" or requestText contains "immediately") "high"
              else if (requestText contains "normal" or requestText contains "standard") "normal"
              else "normal",
              
    // Extract start date hints
    startDate: if (requestText contains "monday") "next_monday"
               else if (requestText contains "today") "today"
               else if (requestText contains "tomorrow") "tomorrow"
               else "tbd"
}
---
{
    originalPrompt: vars.requestPayload.prompt,
    extractedEntities: extractedData,
    processingTimestamp: now(),
    confidence: 0.85
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <set-variable variableName="extractedEntities" value="#[payload.extractedEntities]" doc:name="Store Extracted Entities"/>
        
        <!-- Generate comprehensive onboarding response -->
        <ee:transform doc:name="Generate Onboarding Response" doc:id="n4l5p6o7-n8b9-o0a1-r2d3-r4e5q6u7e8s9">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
import * from dw::core::Arrays
var entities = vars.extractedEntities
var trackingId = "ONB-" ++ (now() as String {format: "yyyyMMddHHmmss"})
---
{
    success: true,
    trackingId: trackingId,
    processedRequest: {
        originalPrompt: vars.requestPayload.prompt,
        extractedEntities: entities,
        processingTimestamp: now()
    },
    onboardingPlan: {
        department: entities.department,
        jobTitle: entities.jobTitle,
        priority: entities.priority,
        startDate: entities.startDate,
        requiredActions: [
            {
                system: "HR Information System",
                action: "Create employee profile and setup payroll",
                status: "initiated",
                estimatedCompletion: "1-2 business days",
                responsible: "HR Team"
            },
            {
                system: "IT Asset Management", 
                action: "Allocate and configure equipment: " ++ joinBy(entities.equipment, ", "),
                status: "pending",
                estimatedCompletion: "2-3 business days",
                responsible: "IT Operations"
            },
            {
                system: "Security System",
                action: "Generate security credentials and building access",
                status: "queued",
                estimatedCompletion: "1 business day",
                responsible: "Security Team"
            },
            {
                system: "Learning Management System",
                action: "Assign department-specific training modules for " ++ entities.department,
                status: "ready",
                estimatedCompletion: "immediate",
                responsible: "Learning & Development"
            }
        ],
        notifications: [
            {
                recipient: "manager@company.com",
                type: "new_hire_notification",
                status: "sent"
            },
            {
                recipient: "it@company.com", 
                type: "equipment_request",
                status: "sent"
            },
            {
                recipient: "hr@company.com",
                type: "onboarding_checklist",
                status: "sent"
            }
        ]
    },
    summary: "ðŸŽ¯ Onboarding request for " ++ entities.jobTitle ++ " in " ++ entities.department ++ " department has been processed successfully.\n\n" ++
             "ðŸ“‹ SYSTEMS NOTIFIED:\n" ++
             "âœ… HR Information System - Employee profile creation initiated\n" ++
             "âœ… IT Asset Management - Equipment allocation for: " ++ joinBy(entities.equipment, ", ") ++ "\n" ++
             "âœ… Security System - Badge and access permissions configured\n" ++
             "âœ… Learning Management - " ++ entities.department ++ " training modules assigned\n" ++
             "âœ… Email Notifications - All stakeholders informed\n\n" ++
             "â±ï¸ Estimated completion: 2-3 business days\n" ++
             "ðŸ†” Tracking ID: " ++ trackingId
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <logger level="INFO" doc:name="Log Processing Complete" message="NLP processing complete for tracking ID: #[payload.trackingId]"/>
    </flow>
    
    <flow name="create-employee-profile" doc:id="a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/createEmployee" doc:name="Create Employee HTTP Listener" doc:id="f1g2h3i4-j5k6-l7m8-n9o0-p1q2r3s4t5u6"/>
        <set-variable variableName="employeePayload" value="#[payload]" doc:name="Set Employee Payload"/>
        <mcp:call-tool doc:name="Call Create Employee Tool" doc:id="u1v2w3x4-y5z6-a7b8-c9d0-e1f2g3h4i5j6" config-ref="Employee_MCP_Config" toolName="createEmployeeTool">
            <mcp:input><![CDATA[
                {
                    "employeeId": "#[vars.employeePayload.employeeId]",
                    "firstName": "#[vars.employeePayload.firstName]",
                    "lastName": "#[vars.employeePayload.lastName]",
                    "department": "#[vars.employeePayload.department]"
                }
            ]]></mcp:input>
        </mcp:call-tool>
        <db:insert doc:name="Insert Employee" doc:id="k1l2m3n4-o5p6-q7r8-s9t0-u1v2w3x4y5z6" config-ref="Database_Config">
            <db:sql><![CDATA[INSERT INTO employees (employee_id, first_name, last_name, department, status, created_date) VALUES (:employeeId, :firstName, :lastName, :department, 'onboarding', NOW())]]></db:sql>
            <db:input-parameters><![CDATA[
                {
                    "employeeId": "#[vars.employeePayload.employeeId]",
                    "firstName": "#[vars.employeePayload.firstName]",
                    "lastName": "#[vars.employeePayload.lastName]",
                    "department": "#[vars.employeePayload.department]"
                }
            ]]></db:input-parameters>
        </db:insert>
        <ee:transform doc:name="Transform Response" doc:id="t1u2v3w4-x5y6-z7a8-b9c0-d1e2f3g4h5i6">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    success: true,
    message: "Employee profile created successfully",
    employeeId: vars.employeePayload.employeeId,
    employee: {
        id: vars.employeePayload.employeeId,
        firstName: vars.employeePayload.firstName,
        lastName: vars.employeePayload.lastName,
        department: vars.employeePayload.department,
        status: "onboarding",
        createdAt: now()
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>

    <flow name="get-employee-profile" doc:id="b2c3d4e5-f6g7-h8i9-j0k1-l2m3n4o5p6q7">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/getEmployee/{employeeId}" doc:name="Get Employee HTTP Listener" doc:id="g2h3i4j5-k6l7-m8n9-o0p1-q2r3s4t5u6v7"/>
        <set-variable variableName="employeeId" value="#[attributes.uriParams.employeeId]" doc:name="Set Employee ID"/>
        <db:select doc:name="Select Employee" doc:id="l2m3n4o5-p6q7-r8s9-t0u1-v2w3x4y5z6a7" config-ref="Database_Config">
            <db:sql><![CDATA[SELECT * FROM employees WHERE employee_id = :employeeId]]></db:sql>
            <db:input-parameters><![CDATA[
                {
                    "employeeId": "#[vars.employeeId]"
                }
            ]]></db:input-parameters>
        </db:select>
        <ee:transform doc:name="Transform Response" doc:id="u2v3w4x5-y6z7-a8b9-c0d1-e2f3g4h5i6j7">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
if (payload != [])
{
    success: true,
    employee: payload[0]
}
else
{
    success: false,
    error: "Employee not found"
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>

    <flow name="list-employees" doc:id="c3d4e5f6-g7h8-i9j0-k1l2-m3n4o5p6q7r8">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/listEmployees" doc:name="List Employees HTTP Listener" doc:id="h3i4j5k6-l7m8-n9o0-p1q2-r3s4t5u6v7w8"/>
        <db:select doc:name="Select All Employees" doc:id="m3n4o5p6-q7r8-s9t0-u1v2-w3x4y5z6a7b8" config-ref="Database_Config">
            <db:sql><![CDATA[SELECT * FROM employees ORDER BY created_date DESC]]></db:sql>
        </db:select>
        <ee:transform doc:name="Transform Response" doc:id="v3w4x5y6-z7a8-b9c0-d1e2-f3g4h5i6j7k8">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    success: true,
    employees: payload,
    count: sizeOf(payload)
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>

    <flow name="update-onboarding-task" doc:id="d4e5f6g7-h8i9-j0k1-l2m3-n4o5p6q7r8s9">
        <http:listener config-ref="Employee_Onboarding_Listener_config" path="/updateTask" doc:name="Update Task HTTP Listener" doc:id="i4j5k6l7-m8n9-o0p1-q2r3-s4t5u6v7w8x9"/>
        <set-variable variableName="taskPayload" value="#[payload]" doc:name="Set Task Payload"/>
        <db:update doc:name="Update Employee Task" doc:id="n4o5p6q7-r8s9-t0u1-v2w3-x4y5z6a7b8c9" config-ref="Database_Config">
            <db:sql><![CDATA[UPDATE employees SET onboarding_tasks = :tasks WHERE employee_id = :employeeId]]></db:sql>
            <db:input-parameters><![CDATA[
                {
                    "employeeId": "#[vars.taskPayload.employeeId]",
                    "tasks": "#[vars.taskPayload.tasks]"
                }
            ]]></db:input-parameters>
        </db:update>
        <ee:transform doc:name="Transform Response" doc:id="w4x5y6z7-a8b9-c0d1-e2f3-g4h5i6j7k8l9">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    success: true,
    message: "Onboarding task updated successfully",
    employeeId: vars.taskPayload.employeeId
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>

</mule>
